function InitFileInputDOM(callback,acceptType="image/*",parentDOM=document.body){let DOM=document.getElementById("FILEINPUT");if(DOM===null){$(parentDOM).append($(`<input id="FILEINPUT" style="display:none;" type="file" accept="${acceptType}">`))}else{$(DOM).attr("accept",acceptType)}if(typeof callback==="function"){callback()}}function PickImg(callback,callbackError,withoutZip=true,DOM=document.getElementById("FILEINPUT")){DOM.onchange=function(){try{if(DOM.files[0]){FileToDataURL(DOM.files[0],(function(res){if(typeof callback==="function"){callback(res)}}),withoutZip)}else{if(typeof callbackError==="function"){callbackError()}}}catch(e){console.log(e)}};DOM.click()}function PickFile(callback,callbackError,readToBuf=false,DOM=document.getElementById("FILEINPUT")){DOM.onchange=function(){try{if(DOM.files[0]){if(readToBuf){FileToBuffer(DOM.files[0],callback,callbackError)}else{callback(DOM.files[0].name,DOM.files[0].size,DOM.files[0])}}else{if(typeof callbackError==="function"){callbackError()}}}catch(e){if(typeof callbackError==="function"){callbackError()}}};DOM.click()}function FileToBuffer(file,callback,callbackError){var reader=new FileReader;reader.onloadend=function(e){try{let res=e.target.result;if(e.target.error!==null)throw"read failed: "+e.target.error.message;if(typeof callback==="function")callback(file.name,res.byteLength,res)}catch(ex){console.log(ex);if(typeof callbackError==="function")callbackError()}};reader.readAsArrayBuffer(file)}function FileToDataURL(file,callback,withoutZip){var reader=new FileReader;reader.onloadend=function(e){try{let res=e.target.result;if(withoutZip){if(typeof callback==="function")callback(res);return}ZipImgFile(res,{zoom:.75,width:800},(function(res1){res=res1;if(typeof callback==="function")callback(res)}))}catch(ex){console.log(ex)}};reader.readAsDataURL(file)}function ZipImgFile(base64,config,callback){if(!base64)return base64;var img=new Image;img.src=base64;img.onload=function(){var res;var ext=base64.substring(base64.indexOf("/")+1,base64.indexOf(";")).toLowerCase();if(this.width>50&&this.height>50&&ext!=="gif"){var scale=this.width/this.height;var w,h;if(config.zoom){w=this.width*config.zoom;h=this.height*config.zoom}if(!config.zoom||config.width&&w>config.width||config.height&&h>config.height){w=config.width||this.width;h=config.height||w/scale;if(config.height&&!config.width){w=h*scale}}var canvas=document.createElement("canvas");var ctx=canvas.getContext("2d");var anw=document.createAttribute("width");var anh=document.createAttribute("height");anw.nodeValue=w;anh.nodeValue=h;canvas.setAttributeNode(anw);canvas.setAttributeNode(anh);ctx.drawImage(this,0,0,w,h);res=canvas.toDataURL("image/"+ext,config.quality||.8);if(res.length>=base64.length){res=base64}}else{res=base64}console.log("压缩前大小: "+base64.length+"  |  压缩后大小: "+res.length);if(typeof callback==="function")callback(res)}}function ZipImgHTML(htmlDOM,callback){let imgs=$(' img[src*="base64"]:not([class~="drawn"])',htmlDOM);if(imgs.length===0){if(typeof callback==="function")callback(htmlDOM.html());return}let zipCnt=0;for(let i of imgs){ZipImgFile(imgs[i].src,{zoom:.75,width:500},(function(base64){imgs[i].src=base64;imgs[i].classList.add("drawn");if(++zipCnt===imgs.length){if(typeof callback==="function")callback(htmlDOM.html())}}))}}
