var PageCompleted=false;function PageComplete(){PageCompleted=true;$(document.body).trigger("pageCompleted");$(document.body).trigger("BgScrollStart")}var BlogPage={Ajax:{call:(url,data,success,error,complete,dataType="json",contentType="application/json",method="post")=>{if(typeof data==="object"){data=JSON.stringify(data)}$.ajax({url:url,method:method,contentType:contentType,data:data,dataType:dataType,success:function(res){if(typeof success==="function"){success(res)}else{location.reload()}},error:function(){if(typeof error==="function"){error()}else{BlogPage.PopWindow.openAsNote("callAjaxFailed","失败","请检查您的网络连接, 或稍后再试.")}},complete:complete})}},PopWindow:{WinInfo:class{id;node;callbackOk;callbackCancel;constructor(id,node,ok,cancel){this.id=id;this.node=node;this.callbackOk=ok;this.callbackCancel=cancel}ok=()=>{if(typeof this.callbackOk==="function")this.callbackOk(this.node.children(".pop-content"));BlogPage.PopWindow.close(this.id)};cancel=()=>{if(typeof this.callbackCancel==="function")this.callbackCancel();BlogPage.PopWindow.close(this.id)}},wins:[],open:(id,title,html,done,ok,cancel)=>{if(BlogPage.PopWindow.find(id)!==-1){return false}try{let win=new BlogPage.PopWindow.WinInfo(id,undefined,ok,cancel);let node=$('<div class="pop-window"></div>').attr("id","PopWindow-"+id).append($('<div class="pop-background"></div>').click(win.cancel)).append($('<div class="mybox pop-content"></div>').append($('<p class="pop-title"></p>').text(title)).append($('<div class="pop-html"></div>').html(html)).append($('<div class="btn-bar"></div>').append($('<a href="javascript:void(0);" class="button colorful">Cancel</a>').click(win.cancel)).append($('<a href="javascript:void(0);" class="button colorful">OK</a>').click(win.ok))));win.node=node;$(top.document.body).append(node);BlogPage.PopWindow.wins.push(win);node.fadeTo(100,1);if(typeof done==="function")done(node.children(".pop-content"))}catch(e){console.log(e);return false}return true},close:id=>{let index=BlogPage.PopWindow.find(id);if(index!==-1){BlogPage.PopWindow.wins[index].node.fadeTo(100,0,undefined,(function(){$(BlogPage.PopWindow.wins[index].node).remove();BlogPage.PopWindow.wins.splice(index,1)}));return true}else{return false}},find:id=>{for(let i=0;i<BlogPage.PopWindow.wins.length;i++){if(BlogPage.PopWindow.wins[i].id===id){return i}}return-1},openAsInput:(id,title,type,text,ok,cancel)=>{BlogPage.PopWindow.open(id,title,$('<input type="'+type+'">'),(ele=>{let inputEle=ele.find("input");inputEle.keypress((function(e){if(e.keyCode===13){ele.find(".btn-bar>.button[value=OK]").click()}}));text=text??"";inputEle.val(text);inputEle.focus()}),(function(ele){if(typeof ok==="function")ok(ele.find("input").val())}),(function(){if(typeof cancel==="function")cancel()}))},openAsNote:(id,title,content,ok,cancel)=>{BlogPage.PopWindow.open(id,title,$("<div></div>").html(content),undefined,ok,cancel)},openAsDirSelector:(ok,cancel)=>{BlogPage.Ajax.call("/tool/dirSelector",null,(function(res){BlogPage.PopWindow.open("dirSelector","目录选择",$(res),null,(function(ele){if(typeof ok==="function"){ok(ele.find(".dir-selector .radio[active]").attr("dir-id"))}}),cancel)}),(function(){BlogPage.PopWindow.openAsNote("noDirSelector","请求失败","无法打开目录选择器.")}),undefined,"html")}},Ext:{exts:[],loadJS:(id,src,callback=function(){},doCallbackAlready=true)=>{if(BlogPage.Ext.findJS(id)!==-1){if(doCallbackAlready&&typeof callback==="function")callback();return}let script=document.createElement("script");script.type="text/javascript";script.id=id;script.src=src;script.async=true;script.addEventListener("load",(()=>{if(typeof callback==="function")callback();BlogPage.Ext.exts.push(script)}),false);setTimeout((function(){document.head.appendChild(script)}),100)},findJS:id=>{for(let i=0;i<BlogPage.Ext.exts.length;i++){if(BlogPage.Ext.exts[i].id===id){return i}}return-1},loadGroup:(group,callback,timeout=8e3)=>{let all=group.length;let completed=0;let called=false;if(timeout>0){setTimeout((()=>{if(typeof callback==="function"&&!called){called=true;callback()}}),timeout)}group.forEach((v=>{v.args=v.args??[];v.callback=v.callback??(()=>{});let tCallback=()=>{v.callback();if(++completed>=all){if(typeof callback==="function"&&!called){called=true;callback()}}};v.args.push(tCallback);setTimeout((()=>{v.func.apply(this,v.args)}))}))},loadShowdown:(dst,src,callback)=>{let srcText;if(typeof src==="string"){srcText=src}else{srcText=$(src).text()}srcText=srcText.replace(/\\\\/g,`\\\\\\\\`);BlogPage.Ext.loadJS("showdown",`${CDN}js/showdown.min.js`,(()=>{let converter=new showdown.Converter;converter.setOption("literalMidWordUnderscores",true);converter.setOption("tables",true);converter.setOption("tasklists",true);converter.setOption("smoothLivePreview",true);converter.setOption("openLinksInNewWindow",true);$(dst).html(converter.makeHtml(srcText));Array.from($("h1,h2,h3,h4,h5,h6")).forEach((ele=>{$(ele).attr("id",$(ele).text())}));$(dst).css("transition","opacity 0.5s ease-out");$(dst).removeClass("undisplay");if(typeof callback==="function")callback()}))},loadHighlight:callback=>{BlogPage.Ext.loadJS("hljs",`${CDN}js/highlight/highlight.pack.js`,(()=>{hljs.initHighlighting();if(typeof callback==="function"){callback()}}))},loadGraph:callback=>{if(typeof callback==="function"){callback()}},loadTex:callback=>{window.MathJax={tex:{inlineMath:[["$","$"]],displayMath:[["$$","$$"]]},startup:{pageReady:()=>MathJax.startup.defaultPageReady().then((()=>{let mjStyleNode=document.getElementById("MJX-CHTML-styles");mjStyleNode.innerHTML=mjStyleNode.innerHTML.replace(/"[^"]*(woff-v2\/[^"]*)"/g,`"${CDN}fonts/$1"`);if(typeof callback==="function"){callback()}}))}};BlogPage.Ext.loadJS("mathJax",`${CDN}js/mathjax/tex-chtml.js`,(()=>{}))},loadStaticFiles:callback=>{BlogPage.Ext.loadGroup([{func:BlogPage.Ext.loadJS,args:["conBg",`${CDN}js/conBg.${USE_MIN_STR}js`]},{func:BlogPage.Ext.loadJS,args:["conLogin",`${CDN}js/conLogin.${USE_MIN_STR}js`],callback:()=>{BlogPage.Ext.loadJS("conNavLoc",`${CDN}js/conNavLoc.${USE_MIN_STR}js`)}}],callback)}}};
